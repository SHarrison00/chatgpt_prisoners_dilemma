<html>

<head>

<link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
<script defer src="https://pyscript.net/alpha/pyscript.js"></script>
<script src="https://cdn.example.com/library.js"></script>

</head>

<style>
    input[type=text], select {
      width: 100%;
      padding: 12px 20px;
      margin: 8px 0;
      display: inline-block;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    input[type=submit] {
      width: 100%;
      background-color: #4c4faf;
      color: white;
      padding: 14px 20px;
      margin: px 0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    input[type=submit]:hover {
      background-color: #45a049;
    }

    p {
      border-radius: 5px;
      background-color: #f2f2f2;
      padding: 20px;
    }
    </style>

<body style='margin-top:50;margin-left:50;margin-right:50;margin-bottom:50;'>
    <p style="text-align: center;">
      <b>Prisoner's Dilemma</b>
    </p>

    <style>
      img {
        max-width: 55%;
        max-height: 55%;
      }
    </style>

    <center>
        <img src="rules_image.jpg" alt="rules">
    </center>

        <i id="narrator_response_header">Narrator says:</i>
    <div id = 'narrator_response_text'>
        Welcome to the Prisoner's Dilemma! Before we begin, please review the rules at the top of the page. In this
        game, you and your opponent (that is, the computer) will each choose to either cooperate or betray each other.
        If you both cooperate, you will each receive a moderate reward. If you betray each other, you will each receive
        a small reward. However, if one betrays while the other cooperates, the betrayer will receive a large reward
        while the cooperator receives nothing. To get started, please enter your name below. The game will then begin
        when you make your first move, so choose wisely! Good luck!
    </div>
    <br>
    <i id = 'comp_response_audio_header'>Press play below to hear the narrator:</i>
    <audio id = "audio_ctrl_element" controls>
        <source id = "audio_src_element" src="Response_00.mp3" type="audio/mpeg">
    </audio>

    <br>
    <br>


    <form onsubmit="return false">
        <label for="name">Input your name below.</label><br>
        <input type="text" id="name" name="name" value="(Enter your name here)"><br>

        <select name="choice" id="choice">
            <option value="cooperate">Cooperate</option>
            <option value="betray">Betray</option>
        </select>

        <input pys-onClick="sub" type="submit" id="btn-form" value="Submit Choice">
    </form>

    <b>Result:</b>
    <div id = 'user_dec'></div>
    <div id = 'comp_dec'></div>
    <br>
    <div id = 'user_running_total'></div>
    <div id = 'comp_running_total'></div>
    <br>
    <div id = 'user_history'></div>
    <div id = 'comp_history'></div>

    <br>
    <i id="comp_response_header">Computer says:</i>
    <div id = 'comp_response_text'>Welcome to the game.</div>

    </audio>
    <audio id = "ResponseExample2.mp3" style="display: none;">
        <source src="ResponseExample2.mp3" type="audio/mpeg">
    </audio>

    <py-script>
## Python code from the ipd.py file.
## All functions in here are meant to be used within Python only.
class play_ipd:
    """
    Class to play Iterable Prisoner's Dilemma.
    """
    @classmethod
    def __init__(self, N, strategy):
        self.N = N
        self.counter = 0
        self.strategy = strategy
        self.user_running_total = 0
        self.comp_running_total = 0
        self.user_history = []
        self.comp_history = []
        self.comp_response_audio_file = ""
        self.comp_response = ""

    @classmethod
    def set_payoffs(self, T, R, P, S):
        """
        Set payoffs for the game.

        T=Temptation, R=Reward, P=Punishment, S=Sucker
        """
        assert (T > R > P > S)
        self.T = T
        self.R = R
        self.P = P
        self.S = S

    def get_computer_decision(self):
        """
        Get computer decision, dependent on their strategy.
        """
        if self.strategy == "UB":
            self.comp_last_decision = "betray"

    @classmethod
    def request_user_decision(self):
        """
        Request the user for their next decision.
        """
        # Prompt the user for input
        user_input = input("Cooperate (C) or Betray (B) your fellow prisoner? Enter a value: ")

        # Keep asking for input until the user provides a valid value
        while user_input not in ["C", "B"]:
            print("Invalid input, please try again.")
            user_input = input("Cooperate (C) or Betray (B) your fellow prisoner? Enter a value: ")

        # Add the user input to the last decision attribute
        self.user_last_decision = user_input

    def update_running_totals(self):
        """
        Update running totals for both the user and the computer.
        """
        if self.user_last_decision == "cooperate" and self.comp_last_decision == "cooperate":
            self.user_running_total += self.R
            self.comp_running_total += self.R
        elif self.user_last_decision == "cooperate" and self.comp_last_decision == "betray":
            self.user_running_total += self.S
            self.comp_running_total += self.T
        elif self.user_last_decision == "betray" and self.comp_last_decision == "cooperate":
            self.user_running_total += self.T
            self.comp_running_total += self.S
        elif self.user_last_decision == "betray" and self.comp_last_decision == "betray":
            self.user_running_total += self.P
            self.comp_running_total += self.P

    def update_history(self):
        """
        Update history of choices made by the user and computer.
        """
        self.user_history.append(self.user_last_decision)
        self.comp_history.append(self.comp_last_decision)

    def computer_response(self):
        self.comp_response_audio_file = "ResponseExample2.mp3"
        self.comp_response_text = "I am sorry for betraying you..."

    </py-script>
    <py-script>
import js
from js import document
import webbrowser

# Initialise the number of games, settings, strategy and iteration number
game_obj = play_ipd(N=3, strategy="UB")
game_obj.set_payoffs(5,3,1,0)
game_obj.get_computer_decision()

# Define functions to be called
def sub(*args,**kwargs):
    # If we haven't exceeded max number of games
    if game_obj.counter < game_obj.N:
        # User last decision: set placement location and variable that will be provided
        game_obj.user_last_decision = Element('choice').value
        user_dec_place = Element('user_dec') # Set the id value of where we want to place the variable
        user_dec_place.write(f"{Element('name').value} chose to {Element('choice').value}.") # Set the variable that will be provided

        # Computer last decision: set placement location and variable that will be provided
        game_obj.get_computer_decision()
        comp_dec_place = Element('comp_dec')
        comp_dec_place.write(f"Computer chose to {game_obj.comp_last_decision}.")

        # Updated running totals: place them and provide variable values
        game_obj.update_running_totals()
        urt_dec_place = Element('user_running_total')
        urt_dec_place.write(f"{Element('name').value}'s Running Total: {game_obj.user_running_total}")
        crt_dec_place = Element('comp_running_total')
        crt_dec_place.write(f"Comp Running Total: {game_obj.comp_running_total}")

        # Updated histories: place them and provide variable values
        game_obj.update_history()
        user_history_place = Element('user_history')
        user_history_place.write(f"{Element('name').value}'s History: {str(game_obj.user_history)}")
        comp_history_place = Element('comp_history')
        comp_history_place.write(f"Computer History: {str(game_obj.comp_history)}")

        # Show computer response: place, and provide text variable
        game_obj.computer_response()
        comp_response_text_place = Element('comp_response_text')
        comp_response_text_place.write(f"{game_obj.comp_response_text}")
        # Play sound
        document.getElementById(f"{game_obj.comp_response_audio_file}").play()

        # Add one to the counter for number of games played
        game_obj.counter += 1
    </py-script>
</body>
</html>